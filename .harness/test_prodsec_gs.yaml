pipeline:
  name: test_prodsec_gs
  identifier: test_prodsec_gs
  projectIdentifier: Security_Test_Scans
  orgIdentifier: default
  tags: {}
  stages:
    - stage:
        name: Semgrep Scan - Multiple repos
        identifier: Semgrep_Scan_Multiple_repos
        description: ""
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Semgrep_Scan
                  identifier: Semgrep_Scan
                  spec:
                    shell: Bash
                    executionTarget: {}
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash

                          # Step 1: Clone the repository containing the orgs_repos.txt file
                          echo "Cloning the repository containing orgs_repos.txt..."
                          git clone https://github.com/gunwantsingh-harness/test_app.git
                          cd test_app || exit 1

                          # Step 2: Read and parse the orgs_repos.txt file
                          declare -A orgs_and_repos
                          while IFS=: read -r org repos; do
                              # Remove leading/trailing whitespaces and commas
                              org=$(echo "$org" | xargs)
                              repos=$(echo "$repos" | xargs | sed 's/,/ /g')
                              orgs_and_repos[$org]=$repos
                          done < orgs_repos.txt

                          # Step 3: Function to clone the default branch, print the default branch, run Semgrep, and print results summary
                          scan_repo() {
                              local org=$1
                              local repo=$2

                              echo "Scanning repo: ${org}/${repo}"

                              # Clone the repository
                              git clone https://github.com/${org}/${repo}.git
                              cd ${repo} || exit 1

                              # List contents of the cloned repo
                              echo "Contents of ${repo}:"
                              ls

                              # Fetch the default branch
                              default_branch=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')

                              # Print the default branch
                              echo "Default branch for ${repo} is ${default_branch}"

                              # Checkout the default branch
                              git checkout $default_branch

                              # Run Semgrep on the default branch and store results in SARIF format
                              result_file="../${repo}_results.sarif"
                              semgrep ci --config auto --sarif -o $result_file

                              # Print the SARIF results file path
                              echo "Completed scanning ${repo}. Results stored in ${result_file}"

                              # Print summary of the scan
                              if [ -f "$result_file" ]; then
                                  issues_count=$(jq '.runs[0].results | length' $result_file)
                                  echo "Summary for ${repo}:"
                                  echo "Total issues found: $issues_count"
                                  if [ "$issues_count" -gt 0 ]; then
                                      jq -r '.runs[0].results[] | "Rule: \(.ruleId), Severity: \(.level), Message: \(.message.text)"' $result_file
                                  fi
                              else
                                  echo "No results file generated for ${repo}"
                              fi

                              # Move back to the parent directory and clean up
                              cd ..
                              echo "Cleaning up cloned repo: ${repo}"
                              rm -rf ${repo}

                              # List all the cloned repositories after each scan
                              echo "Listing all cloned repositories and results:"
                              ls
                          }

                          # Step 4: Loop through each org and its repos
                          for org in "${!orgs_and_repos[@]}"; do
                              repos=${orgs_and_repos[$org]}
                              for repo in $repos; do
                                  scan_repo $org $repo
                              done
                          done

                          # Step 5: List all repositories and their results
                          echo " ***** Final list of all repositories and Semgrep result files *****"
                          ls
                    environmentVariables: []
                    outputVariables: []
                  timeout: 10m
        tags: {}
